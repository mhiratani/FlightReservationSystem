<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ãƒ©ã‚¤ãƒˆäºˆç´„ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        form {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.delete {
            background-color: #f44336;
        }
        button.delete:hover {
            background-color: #da190b;
        }
        button.secondary {
            background-color: #888;
        }
        button.secondary:hover {
            background-color: #666;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .flight-row {
            cursor: pointer;
        }
        .flight-row:hover {
            background-color: #e8f5e9 !important;
        }
        .detail-row {
            background-color: #f9f9f9;
            display: none;
        }
        .detail-row.active {
            display: table-row;
        }
        .detail-content {
            padding: 20px;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .detail-item {
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .detail-item strong {
            display: block;
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .status-reserved {
            color: #2196F3;
            font-weight: bold;
        }
        .status-boarded {
            color: #4CAF50;
            font-weight: bold;
        }
        .status-cancelled {
            color: #f44336;
            font-weight: bold;
        }
        #editForm {
            border: 2px solid #4CAF50;
            margin-top: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        hr {
            margin: 30px 0;
            border: none;
            border-top: 2px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœˆï¸ ãƒ•ãƒ©ã‚¤ãƒˆäºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <h2>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
        <div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
            <label for="pdfFile" style="display: block; margin-bottom: 10px;">
                <strong>Eãƒã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆPDF/ç”»åƒï¼‰ï¼š</strong>
            </label>
            <input type="file" id="pdfFile" accept=".pdf,.png,.jpg,.jpeg,.webp,.gif" style="margin-bottom: 10px;">
            <button type="button" onclick="importFromFile()">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º</button>
            <div id="pdfImportStatus" style="margin-top: 10px;"></div>
            
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div id="previewSection" style="display: none; margin-top: 20px;">
                <h3>æŠ½å‡ºã•ã‚ŒãŸãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ï¼ˆç¢ºèªãƒ»ç·¨é›†ï¼‰</h3>
                <div id="previewTable"></div>
                <button type="button" onclick="registerAllFlights()" style="background-color: #4CAF50; margin-top: 10px;">
                    âœ… ã™ã¹ã¦ç™»éŒ²
                </button>
                <button type="button" onclick="clearPreview()" class="secondary" style="margin-top: 10px;">
                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
        
        <hr>
        
        <h2>ğŸ“ æ–°è¦ãƒ•ãƒ©ã‚¤ãƒˆè¿½åŠ </h2>
        <form id="addForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="flight_date">æ­ä¹—æ—¥ä»˜ *</label>
                    <input type="date" id="flight_date" name="flight_date" required>
                </div>
                <div class="form-group">
                    <label for="flight_number">ãƒ•ãƒ©ã‚¤ãƒˆNO *</label>
                    <input type="text" id="flight_number" name="flight_number" placeholder="ä¾‹: NH123" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="departure_airport">å‡ºç™ºåœ°(3ãƒ¬ã‚¿ãƒ¼) *</label>
                    <input type="text" id="departure_airport" name="departure_airport" placeholder="ä¾‹: NRT" maxlength="3" required>
                </div>
                <div class="form-group">
                    <label for="arrival_airport">åˆ°ç€åœ°(3ãƒ¬ã‚¿ãƒ¼) *</label>
                    <input type="text" id="arrival_airport" name="arrival_airport" placeholder="ä¾‹: HND" maxlength="3" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="departure_time">å‡ºç™ºæ™‚åˆ»</label>
                    <input type="time" id="departure_time" name="departure_time">
                </div>
                <div class="form-group">
                    <label for="arrival_time">åˆ°ç€æ™‚åˆ»</label>
                    <input type="time" id="arrival_time" name="arrival_time">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="reservation_number">äºˆç´„ç•ªå· *</label>
                    <input type="text" id="reservation_number" name="reservation_number" placeholder="ä¾‹: ABC123" required>
                </div>
                <div class="form-group">
                    <label for="seat_number">åº§å¸­ç•ªå·</label>
                    <input type="text" id="seat_number" name="seat_number" placeholder="ä¾‹: 12A">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                    <select id="status" name="status" required>
                        <option value="Reserved" selected>Reservedï¼ˆäºˆç´„æ¸ˆã¿ï¼‰</option>
                        <option value="Boarded">Boardedï¼ˆæ­ä¹—æ¸ˆã¿ï¼‰</option>
                        <option value="Cancelled">Cancelledï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment_amount">æ”¯æ‰•é¡</label>
                    <input type="number" id="payment_amount" name="payment_amount" step="0.01" placeholder="ä¾‹: 25000">
                </div>
            </div>
            
            <div class="form-group">
                <label for="currency">é€šè²¨</label>
                <select id="currency" name="currency">
                    <option value="JPY">JPYï¼ˆæ—¥æœ¬å††ï¼‰</option>
                    <option value="USD">USDï¼ˆç±³ãƒ‰ãƒ«ï¼‰</option>
                    <option value="EUR">EURï¼ˆãƒ¦ãƒ¼ãƒ­ï¼‰</option>
                    <option value="GBP">GBPï¼ˆè‹±ãƒãƒ³ãƒ‰ï¼‰</option>
                    <option value="CNY">CNYï¼ˆäººæ°‘å…ƒï¼‰</option>
                    <option value="KRW">KRWï¼ˆéŸ“å›½ã‚¦ã‚©ãƒ³ï¼‰</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="notes">ãƒ¡ãƒ¢</label>
                <textarea id="notes" name="notes" rows="3" placeholder="ãã®ä»–ã®ãƒ¡ãƒ¢"></textarea>
            </div>
            
            <button type="submit">è¿½åŠ </button>
        </form>
        
        <hr>
        
        <h2>ğŸ“‹ ãƒ•ãƒ©ã‚¤ãƒˆä¸€è¦§</h2>
        <button onclick="loadFlights()">ğŸ”„ æ›´æ–°</button>
        <button onclick="exportFlights()" class="secondary">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <div id="flightsList"></div>
        
        <hr>
        
        <div id="editForm" style="display:none;">
            <h2>âœï¸ ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h2>
            <form id="updateForm">
                <input type="hidden" id="editId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFlightDate">æ­ä¹—æ—¥ä»˜ *</label>
                        <input type="date" id="editFlightDate" name="editFlightDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editFlightNumber">ãƒ•ãƒ©ã‚¤ãƒˆNO *</label>
                        <input type="text" id="editFlightNumber" name="editFlightNumber" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editDepartureAirport">å‡ºç™ºåœ°(3ãƒ¬ã‚¿ãƒ¼) *</label>
                        <input type="text" id="editDepartureAirport" name="editDepartureAirport" maxlength="3" required>
                    </div>
                    <div class="form-group">
                        <label for="editArrivalAirport">åˆ°ç€åœ°(3ãƒ¬ã‚¿ãƒ¼) *</label>
                        <input type="text" id="editArrivalAirport" name="editArrivalAirport" maxlength="3" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editDepartureTime">å‡ºç™ºæ™‚åˆ»</label>
                        <input type="time" id="editDepartureTime" name="editDepartureTime">
                    </div>
                    <div class="form-group">
                        <label for="editArrivalTime">åˆ°ç€æ™‚åˆ»</label>
                        <input type="time" id="editArrivalTime" name="editArrivalTime">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editReservationNumber">äºˆç´„ç•ªå· *</label>
                        <input type="text" id="editReservationNumber" name="editReservationNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="editSeatNumber">åº§å¸­ç•ªå·</label>
                        <input type="text" id="editSeatNumber" name="editSeatNumber">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                        <select id="editStatus" name="editStatus" required>
                            <option value="Reserved">Reservedï¼ˆäºˆç´„æ¸ˆã¿ï¼‰</option>
                            <option value="Boarded">Boardedï¼ˆæ­ä¹—æ¸ˆã¿ï¼‰</option>
                            <option value="Cancelled">Cancelledï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPaymentAmount">æ”¯æ‰•é¡</label>
                        <input type="number" id="editPaymentAmount" name="editPaymentAmount" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editCurrency">é€šè²¨</label>
                    <select id="editCurrency" name="editCurrency">
                        <option value="JPY">JPYï¼ˆæ—¥æœ¬å††ï¼‰</option>
                        <option value="USD">USDï¼ˆç±³ãƒ‰ãƒ«ï¼‰</option>
                        <option value="EUR">EURï¼ˆãƒ¦ãƒ¼ãƒ­ï¼‰</option>
                        <option value="GBP">GBPï¼ˆè‹±ãƒãƒ³ãƒ‰ï¼‰</option>
                        <option value="CNY">CNYï¼ˆäººæ°‘å…ƒï¼‰</option>
                        <option value="KRW">KRWï¼ˆéŸ“å›½ã‚¦ã‚©ãƒ³ï¼‰</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">ãƒ¡ãƒ¢</label>
                    <textarea id="editNotes" name="editNotes" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="eticketUpload">Eãƒã‚±ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (PDF)</label>
                    <input type="file" id="eticketUpload" accept=".pdf">
                    <button type="button" onclick="uploadEticket()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                    <div id="currentEticket"></div>
                </div>
                
                <button type="submit">æ›´æ–°</button>
                <button type="button" onclick="cancelEdit()" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://192.168.1.6:8002/api';
        
        // ãƒ•ãƒ©ã‚¤ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadFlights() {
            try {
                const response = await fetch(`${API_BASE}/flights`);
                const flights = await response.json();
                
                const listDiv = document.getElementById('flightsList');
                
                if (flights.length === 0) {
                    listDiv.innerHTML = '<p>ãƒ•ãƒ©ã‚¤ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                let html = '<table>';
                html += '<tr><th>æ­ä¹—æ—¥</th><th>ãƒ•ãƒ©ã‚¤ãƒˆ</th><th>ãƒ«ãƒ¼ãƒˆ</th><th>äºˆç´„ç•ªå·</th><th>åº§å¸­</th><th>æ”¯æ‰•é¡</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th></tr>';
                
                flights.forEach(flight => {
                    const statusClass = `status-${flight.status.toLowerCase()}`;
                    const paymentInfo = flight.payment_amount 
                        ? `${flight.payment_amount} ${flight.currency || 'JPY'}`
                        : '-';
                    
                    html += `
                        <tr class="flight-row" onclick="toggleFlightDetail(${flight.id})">
                            <td>${escapeHtml(flight.flight_date)}</td>
                            <td>${escapeHtml(flight.flight_number)}</td>
                            <td>${escapeHtml(flight.departure_airport)} â†’ ${escapeHtml(flight.arrival_airport)}</td>
                            <td>${escapeHtml(flight.reservation_number)}</td>
                            <td>${escapeHtml(flight.seat_number || '-')}</td>
                            <td>${escapeHtml(paymentInfo)}</td>
                            <td class="${statusClass}">${escapeHtml(flight.status)}</td>
                            <td onclick="event.stopPropagation()">
                                <button onclick="editFlight(${flight.id})">ç·¨é›†</button>
                                <button onclick="deleteFlight(${flight.id})" class="delete">å‰Šé™¤</button>
                            </td>
                        </tr>
                        <tr class="detail-row" id="detail-${flight.id}">
                            <td colspan="8">
                                <div class="detail-content">
                                    <h3>ãƒ•ãƒ©ã‚¤ãƒˆè©³ç´°æƒ…å ±</h3>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <strong>æ­ä¹—æ—¥</strong>
                                            ${escapeHtml(flight.flight_date)}
                                        </div>
                                        <div class="detail-item">
                                            <strong>ãƒ•ãƒ©ã‚¤ãƒˆç•ªå·</strong>
                                            ${escapeHtml(flight.flight_number)}
                                        </div>
                                        <div class="detail-item">
                                            <strong>å‡ºç™ºæ™‚åˆ»</strong>
                                            ${escapeHtml(flight.departure_time || '-')}
                                        </div>
                                        <div class="detail-item">
                                            <strong>åˆ°ç€æ™‚åˆ»</strong>
                                            ${escapeHtml(flight.arrival_time || '-')}
                                        </div>
                                        <div class="detail-item">
                                            <strong>å‡ºç™ºç©ºæ¸¯</strong>
                                            ${escapeHtml(flight.departure_airport)}
                                        </div>
                                        <div class="detail-item">
                                            <strong>åˆ°ç€ç©ºæ¸¯</strong>
                                            ${escapeHtml(flight.arrival_airport)}
                                        </div>
                                        <div class="detail-item">
                                            <strong>äºˆç´„ç•ªå·</strong>
                                            ${escapeHtml(flight.reservation_number)}
                                        </div>
                                        <div class="detail-item">
                                            <strong>åº§å¸­ç•ªå·</strong>
                                            ${escapeHtml(flight.seat_number || '-')}
                                        </div>
                                        <div class="detail-item">
                                            <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong>
                                            <span class="${statusClass}">${escapeHtml(flight.status)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <strong>æ”¯æ‰•é¡</strong>
                                            ${escapeHtml(paymentInfo)}
                                        </div>
                                        <div class="detail-item">
                                            <strong>ç™»éŒ²æ—¥æ™‚</strong>
                                            ${escapeHtml(flight.created_at ? new Date(flight.created_at).toLocaleString('ja-JP') : '-')}
                                        </div>
                                        <div class="detail-item">
                                            <strong>æ›´æ–°æ—¥æ™‚</strong>
                                            ${escapeHtml(flight.updated_at ? new Date(flight.updated_at).toLocaleString('ja-JP') : '-')}
                                        </div>
                                    </div>
                                    ${flight.notes ? `
                                        <div class="detail-item" style="grid-column: 1 / -1;">
                                            <strong>ãƒ¡ãƒ¢</strong>
                                            ${escapeHtml(flight.notes)}
                                        </div>
                                    ` : ''}
                                    ${flight.eticket_pdf_path ? `
                                        <div style="margin-top: 20px;">
                                            <button onclick="window.open('${API_BASE}/flights/${flight.id}/eticket', '_blank')" style="background-color: #2196F3;">
                                                ğŸ“„ Eãƒã‚±ãƒƒãƒˆ PDFã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã
                                            </button>
                                        </div>
                                    ` : '<p style="color: #999; margin-top: 20px;">ã“ã®ãƒ•ãƒ©ã‚¤ãƒˆã«ã¯Eãƒã‚±ãƒƒãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                listDiv.innerHTML = html;
            } catch (error) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ãƒ©ã‚¤ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ–°è¦è¿½åŠ 
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                flight_date: document.getElementById('flight_date').value,
                departure_airport: document.getElementById('departure_airport').value.toUpperCase(),
                arrival_airport: document.getElementById('arrival_airport').value.toUpperCase(),
                reservation_number: document.getElementById('reservation_number').value,
                flight_number: document.getElementById('flight_number').value,
                seat_number: document.getElementById('seat_number').value || null,
                status: document.getElementById('status').value,
                departure_time: document.getElementById('departure_time').value || null,
                arrival_time: document.getElementById('arrival_time').value || null,
                notes: document.getElementById('notes').value || null,
                payment_amount: document.getElementById('payment_amount').value || null,
                currency: document.getElementById('currency').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/flights`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('ãƒ•ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    document.getElementById('addForm').reset();
                    loadFlights();
                } else {
                    const error = await response.json();
                    alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ãƒ©ã‚¤ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
        
        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        async function editFlight(id) {
            try {
                const response = await fetch(`${API_BASE}/flights/${id}`);
                const flight = await response.json();
                
                document.getElementById('editId').value = flight.id;
                document.getElementById('editFlightDate').value = flight.flight_date;
                document.getElementById('editFlightNumber').value = flight.flight_number;
                document.getElementById('editDepartureAirport').value = flight.departure_airport;
                document.getElementById('editArrivalAirport').value = flight.arrival_airport;
                document.getElementById('editReservationNumber').value = flight.reservation_number;
                document.getElementById('editSeatNumber').value = flight.seat_number || '';
                document.getElementById('editStatus').value = flight.status;
                document.getElementById('editDepartureTime').value = flight.departure_time || '';
                document.getElementById('editArrivalTime').value = flight.arrival_time || '';
                document.getElementById('editPaymentAmount').value = flight.payment_amount || '';
                document.getElementById('editCurrency').value = flight.currency || 'JPY';
                document.getElementById('editNotes').value = flight.notes || '';
                
                // Eãƒã‚±ãƒƒãƒˆæƒ…å ±è¡¨ç¤º
                const eticketDiv = document.getElementById('currentEticket');
                if (flight.eticket_pdf_path) {
                    eticketDiv.innerHTML = `<p>ç¾åœ¨ã®Eãƒã‚±ãƒƒãƒˆ: ${escapeHtml(flight.eticket_pdf_path)}</p>`;
                } else {
                    eticketDiv.innerHTML = '<p>Eãƒã‚±ãƒƒãƒˆæœªç™»éŒ²</p>';
                }
                
                document.getElementById('editForm').style.display = 'block';
                document.getElementById('editForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ãƒ©ã‚¤ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('updateForm').reset();
        }
        
        // æ›´æ–°
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const formData = {
                flight_date: document.getElementById('editFlightDate').value,
                departure_airport: document.getElementById('editDepartureAirport').value.toUpperCase(),
                arrival_airport: document.getElementById('editArrivalAirport').value.toUpperCase(),
                reservation_number: document.getElementById('editReservationNumber').value,
                flight_number: document.getElementById('editFlightNumber').value,
                seat_number: document.getElementById('editSeatNumber').value || null,
                status: document.getElementById('editStatus').value,
                departure_time: document.getElementById('editDepartureTime').value || null,
                arrival_time: document.getElementById('editArrivalTime').value || null,
                notes: document.getElementById('editNotes').value || null,
                payment_amount: document.getElementById('editPaymentAmount').value || null,
                currency: document.getElementById('editCurrency').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/flights/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('ãƒ•ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    cancelEdit();
                    loadFlights();
                } else {
                    const error = await response.json();
                    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ãƒ©ã‚¤ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
        
        // Eãƒã‚±ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadEticket() {
            const id = document.getElementById('editId').value;
            const fileInput = document.getElementById('eticketUpload');
            
            if (!fileInput.files[0]) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_BASE}/flights/${id}/upload-eticket`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Eãƒã‚±ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    document.getElementById('currentEticket').innerHTML = 
                        `<p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿: ${escapeHtml(result.file_path)}</p>`;
                } else {
                    const error = await response.json();
                    alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('Eãƒã‚±ãƒƒãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // å‰Šé™¤
        async function deleteFlight(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/flights/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok || response.status === 204) {
                    alert('ãƒ•ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadFlights();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ãƒ©ã‚¤ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportFlights() {
            try {
                const response = await fetch(`${API_BASE}/flights/export`);
                const blob = await response.blob();
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—
                const contentDisposition = response.headers.get('content-disposition');
                let filename = 'flights_export.json';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£ã®å¤‰æ•°
        let extractedFlights = [];
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importFromFile() {
            const fileInput = document.getElementById('pdfFile');
            const statusDiv = document.getElementById('pdfImportStatus');
            
            if (!fileInput.files[0]) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            statusDiv.innerHTML = '<p style="color: blue;">ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...</p>';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_BASE}/flights/import-from-file`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    extractedFlights = result.flights;
                    
                    statusDiv.innerHTML = `<p style="color: green;">âœ… ${result.message}</p>`;
                    displayPreview(extractedFlights);
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<p style="color: red;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.detail}</p>`;
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                statusDiv.innerHTML = `<p style="color: red;">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</p>`;
            }
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
        function displayPreview(flights) {
            const previewSection = document.getElementById('previewSection');
            const previewTable = document.getElementById('previewTable');
            
            if (flights.length === 0) {
                previewSection.style.display = 'none';
                return;
            }
            
            let html = '<table>';
            html += '<tr><th>æ­ä¹—æ—¥</th><th>ãƒ•ãƒ©ã‚¤ãƒˆ</th><th>ãƒ«ãƒ¼ãƒˆ</th><th>æ™‚åˆ»</th><th>äºˆç´„ç•ªå·</th><th>åº§å¸­</th><th>æ”¯æ‰•é¡</th><th>æ“ä½œ</th></tr>';
            
            flights.forEach((flight, index) => {
                const route = `${flight.departure_airport || '?'} â†’ ${flight.arrival_airport || '?'}`;
                const times = flight.departure_time && flight.arrival_time 
                    ? `${flight.departure_time} - ${flight.arrival_time}`
                    : '-';
                const payment = flight.payment_amount 
                    ? `${flight.payment_amount} ${flight.currency || 'JPY'}`
                    : '-';
                
                html += `
                    <tr id="preview-row-${index}">
                        <td><input type="date" id="preview-date-${index}" value="${flight.flight_date || ''}" style="width: 140px;"></td>
                        <td><input type="text" id="preview-flight-${index}" value="${escapeHtml(flight.flight_number || '')}" style="width: 80px;"></td>
                        <td>${escapeHtml(route)}</td>
                        <td>${escapeHtml(times)}</td>
                        <td><input type="text" id="preview-reservation-${index}" value="${escapeHtml(flight.reservation_number || '')}" style="width: 100px;"></td>
                        <td><input type="text" id="preview-seat-${index}" value="${escapeHtml(flight.seat_number || '')}" style="width: 60px;"></td>
                        <td>${escapeHtml(payment)}</td>
                        <td>
                            <button onclick="registerSingleFlight(${index})" style="padding: 5px 10px;">ç™»éŒ²</button>
                            <button onclick="removePreviewRow(${index})" class="delete" style="padding: 5px 10px;">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</table>';
            previewTable.innerHTML = html;
            previewSection.style.display = 'block';
        }
        
        // å˜ä¸€ãƒ•ãƒ©ã‚¤ãƒˆã‚’ç™»éŒ²
        async function registerSingleFlight(index) {
            if (index < 0 || index >= extractedFlights.length) {
                return;
            }
            
            const flight = extractedFlights[index];
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç·¨é›†ã•ã‚ŒãŸå€¤ã‚’å–å¾—
            const flightDate = document.getElementById(`preview-date-${index}`).value;
            const flightNumber = document.getElementById(`preview-flight-${index}`).value;
            const reservationNumber = document.getElementById(`preview-reservation-${index}`).value;
            const seatNumber = document.getElementById(`preview-seat-${index}`).value;
            
            const formData = {
                flight_date: flightDate,
                flight_number: flightNumber,
                departure_airport: (flight.departure_airport || '').toUpperCase(),
                arrival_airport: (flight.arrival_airport || '').toUpperCase(),
                reservation_number: reservationNumber,
                seat_number: seatNumber || null,
                status: flight.status || 'Reserved',
                departure_time: flight.departure_time || null,
                arrival_time: flight.arrival_time || null,
                payment_amount: flight.payment_amount || null,
                currency: flight.currency || 'JPY',
                notes: null
            };
            
            try {
                const response = await fetch(`${API_BASE}/flights`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert(`ãƒ•ãƒ©ã‚¤ãƒˆ ${flightNumber} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤
                    removePreviewRow(index);
                    loadFlights();
                } else {
                    const error = await response.json();
                    alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ãƒ©ã‚¤ãƒˆã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã™ã¹ã¦ã®ãƒ•ãƒ©ã‚¤ãƒˆã‚’ç™»éŒ²
        async function registerAllFlights() {
            if (extractedFlights.length === 0) {
                alert('ç™»éŒ²ã™ã‚‹ãƒ•ãƒ©ã‚¤ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!confirm(`${extractedFlights.length}ä»¶ã®ãƒ•ãƒ©ã‚¤ãƒˆã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < extractedFlights.length; i++) {
                const flight = extractedFlights[i];
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç·¨é›†ã•ã‚ŒãŸå€¤ã‚’å–å¾—
                const flightDate = document.getElementById(`preview-date-${i}`).value;
                const flightNumber = document.getElementById(`preview-flight-${i}`).value;
                const reservationNumber = document.getElementById(`preview-reservation-${i}`).value;
                const seatNumber = document.getElementById(`preview-seat-${i}`).value;
                
                const formData = {
                    flight_date: flightDate,
                    flight_number: flightNumber,
                    departure_airport: (flight.departure_airport || '').toUpperCase(),
                    arrival_airport: (flight.arrival_airport || '').toUpperCase(),
                    reservation_number: reservationNumber,
                    seat_number: seatNumber || null,
                    status: flight.status || 'Reserved',
                    departure_time: flight.departure_time || null,
                    arrival_time: flight.arrival_time || null,
                    payment_amount: flight.payment_amount || null,
                    currency: flight.currency || 'JPY',
                    notes: null
                };
                
                try {
                    const response = await fetch(`${API_BASE}/flights`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error(`ãƒ•ãƒ©ã‚¤ãƒˆ ${i + 1} ã®ç™»éŒ²ã«å¤±æ•—:`, await response.json());
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`ãƒ•ãƒ©ã‚¤ãƒˆ ${i + 1} ã®ç™»éŒ²ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            alert(`ç™»éŒ²å®Œäº†: æˆåŠŸ ${successCount}ä»¶, å¤±æ•— ${errorCount}ä»¶`);
            clearPreview();
            loadFlights();
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰è¡Œã‚’å‰Šé™¤
        function removePreviewRow(index) {
            extractedFlights.splice(index, 1);
            displayPreview(extractedFlights);
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearPreview() {
            extractedFlights = [];
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('pdfFile').value = '';
            document.getElementById('pdfImportStatus').innerHTML = '';
        }
        
        // ãƒ•ãƒ©ã‚¤ãƒˆè©³ç´°ã®ãƒˆã‚°ãƒ«
        function toggleFlightDetail(flightId) {
            const detailRow = document.getElementById(`detail-${flightId}`);
            
            // ä»–ã®é–‹ã„ã¦ã„ã‚‹è©³ç´°ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('.detail-row.active').forEach(row => {
                if (row.id !== `detail-${flightId}`) {
                    row.classList.remove('active');
                }
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè©³ç´°ã‚’ãƒˆã‚°ãƒ«
            detailRow.classList.toggle('active');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ãƒ©ã‚¤ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
        window.addEventListener('load', loadFlights);
    </script>
</body>
</html>
